---
title: "MAIHDA_population_level"
author: "Victoria Fisher"
date: "2025-01-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(pacman)

p_load(tidyverse,
       tidycensus,
       ggplot2,
       gtsummary,
       DescTools,
       datawizard,
       excessmort,
       lubridate,
       readxl,
       haven,
       MASS,
       lme4,
       lmerTest,
       nlme,
       glmmTMB,
       brms,
       merTools,
       bbmle,
       zctaCrosswalk,
       performance,
       purrr,
       ggpubr,
       foreign,
       DHARMa,
       sf,
       rms,
       mlogit,
       effects,
       splines,
       car,
       Publish,
       msme,
       plm,
       broom,
       forestplot,
       sjPlot,
       sjlabelled,
       sjmisc,
       clusterSim,
       geepack,
       geeM,
       cardx)

options(tigris_use_cache = FALSE)

```

#Loading datasets

```{r}

#Covid mortality

deaths_20_23 <- read_delim('/Users/fisherv1/Library/CloudStorage/OneDrive-MichiganStateUniversity/PROWESS/Research/03_Active Research/MAIHDA_Methods_MS/02_Data/COVID Mortality Statistics 2020 through 2023.txt', 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(Notes = col_skip()), 
    trim_ws = TRUE)

colnames(deaths_20_23)[2] <- "GEOID"
#problems(deaths_20_23)

#ACS

v2020 <- load_variables(2020, "acs5")

vars <- c(county_male_pop = "B01001_002",
          county_white_pop = "B02001_002",
          county_black_pop = "B02001_003",
          county_asian_pop = "B02001_005",
          county_hispanic_pop = "B03002_012",
          county_two_race_plus_pop = "B02001_008",
          age_grp_male_under_5 = "B01001_003",
          age_grp_male_5_9 = "B01001_004",
          age_grp_male_10_14 = "B01001_005",
          age_grp_male_15_17 = "B01001_006",
          age_grp_male_18_19 = "B01001_007",
          age_grp_male_20 = "B01001_008",
          age_grp_male_21 = "B01001_009",
          age_grp_male_22_24 = "B01001_010",
          age_grp_male_25_29 = "B01001_011",
          age_grp_male_30_34 = "B01001_012",
          age_grp_male_35_39 = "B01001_013",
          age_grp_male_40_44 = "B01001_014",
          age_grp_male_45_49 = "B01001_015",
          age_grp_male_50_54 = "B01001_016",
          age_grp_male_55_59 = "B01001_017",
          age_grp_male_60_61 = "B01001_018",
          age_grp_male_62_64 = "B01001_019",
          age_grp_male_65_66 = "B01001_020",
          age_grp_male_67_69 = "B01001_021",
          age_grp_male_70_74 = "B01001_022",
          age_grp_male_75_79 = "B01001_023",
          age_grp_male_80_84 = "B01001_024",
          age_grp_male_85_older = "B01001_025",
          age_grp_female_under_5 = "B01001_027",
          age_grp_female_5_9 = "B01001_028",
          age_grp_female_10_14 = "B01001_029",
          age_grp_female_15_17 = "B01001_030",
          age_grp_female_18_19 = "B01001_031",
          age_grp_female_20 = "B01001_032",
          age_grp_female_21 = "B01001_033",
          age_grp_female_22_24 = "B01001_034",
          age_grp_female_25_29 = "B01001_035",
          age_grp_female_30_34 = "B01001_036",
          age_grp_female_35_39 = "B01001_037",
          age_grp_female_40_44 = "B01001_038",
          age_grp_female_45_49 = "B01001_039",
          age_grp_female_50_54 = "B01001_040",
          age_grp_female_55_59 = "B01001_041",
          age_grp_female_60_61 = "B01001_042",
          age_grp_female_62_64 = "B01001_043",
          age_grp_female_65_66 = "B01001_044",
          age_grp_female_67_69 = "B01001_045",
          age_grp_female_70_74 = "B01001_046",
          age_grp_female_75_79 = "B01001_047",
          age_grp_female_80_84 = "B01001_048",
          age_grp_female_85_older = "B01001_049",
          median_age_total = "B01002_001",
          median_age_male = "B01002_002",
          median_age_female = "B01002_003",
          median_income_12_mo = "B06011_001",
          indv_income_grp_10k_less = "B06010_004",
          indv_income_grp_10_14 = "B06010_005",
          indv_income_grp_15_24 = "B06010_006",
          indv_income_grp_25_34 = "B06010_007",
          indv_income_grp_35_49 = "B06010_008",
          indv_income_grp_50_64 = "B06010_009",
          indv_income_grp_65_74 = "B06010_010",
          indv_income_grp_75_plus = "B06010_011")

years <- 2020:2023 #pulls American Community Survey data from 2019 - 2021
names(years) <- years
vars_county <- purrr::map_dfr(years, ~{
  get_acs(
    geography = "county", 
    variables = vars, 
    year = .x,
    geometry = FALSE
    ) 
}, .id = "year")

vars_county <- vars_county %>%
  pivot_wider(id_cols = c("year", "GEOID"),
              names_from = c("variable"),
              values_from = "estimate")

vars_county <- vars_county %>%
  mutate(
    male_under_18_age = rowSums(select(vars_county, 4:7), na.rm = TRUE),
    male_18_34_age = rowSums(select(vars_county, 8:13), na.rm = TRUE),
    male_35_54_age = rowSums(select(vars_county, 14:17), na.rm = TRUE),
    male_55_64_age = rowSums(select(vars_county, 18:20), na.rm = TRUE),
    male_65_74_age = rowSums(select(vars_county, 21:23), na.rm = TRUE),
    male_75_plus_age = rowSums(select(vars_county, 24:26), na.rm = TRUE),
    female_under_18_age = rowSums(select(vars_county, 27:30), na.rm = TRUE),
    female_18_34_age = rowSums(select(vars_county, 31:36), na.rm = TRUE),
    female_35_54_age = rowSums(select(vars_county, 37:40), na.rm = TRUE),
    female_55_64_age = rowSums(select(vars_county, 41:43), na.rm = TRUE),
    female_65_74_age = rowSums(select(vars_county, 44:46), na.rm = TRUE),
    female_75_plus_age = rowSums(select(vars_county, 47:49), na.rm = TRUE),
    all_under_18 = male_under_18_age + female_under_18_age,
    all_18_34_age = male_35_54_age + female_18_34_age,
    all_35_54_age = male_35_54_age + female_35_54_age,
    all_55_64_age = male_55_64_age + female_55_64_age,
    all_65_74_age = male_65_74_age + female_65_74_age,
    all_75_plus_age = male_75_plus_age + female_75_plus_age
  )


#Total pop and geography
years <- 2020:2023 #pulls American Community Survey data from 2020 - 2023
names(years) <- years
pop_county <- purrr::map_dfr(years, ~{
  get_acs(
    geography = "county", 
    variables = "B01001_001", 
    year = .x,
    geometry = TRUE
    ) 
}, .id = "year") %>% tigris::shift_geometry()

colnames(pop_county)[5] = "total_pop"
pop_county <- pop_county %>% dplyr::select(!c(4,6))

#Merge two datasets

vars_county = merge(pop_county, vars_county, by = c("year", "GEOID"))

#Percentages
colnames(vars_county)
percent_cols <- names(vars_county[, c(5:51, 55:67, 69:86)])

vars_county <- vars_county %>%
  mutate(across(all_of(percent_cols), ~ (. / total_pop) * 100, .names = "P_{.col}"))

vars_county_avg <- vars_county %>%
  group_by(GEOID) %>%
  summarise(across(where(is.numeric), ~mean(.x)))

#Merge with death dataset
rm(df_mort)
df_mort <- merge(deaths_20_23, vars_county_avg, by = "GEOID")

colnames(df_mort)

```

#MAIHDA

```{r}

#Strata: age, sex, income, race

#Income

df_mort <- df_mort %>%
  mutate(
    # Calculate Q1, Q3, and IQR for 'value' (you can replace 'value' with any column)
    Q1 = quantile(median_income_12_mo, 0.25, na.rm = TRUE),
    Q3 = quantile(median_income_12_mo, 0.75, na.rm = TRUE),
    
    # Create categories based on IQR
    strata_income_cat = case_when(
      median_income_12_mo < Q1 ~ "1_income",                # Below the first quartile
      median_income_12_mo >= Q1 & median_income_12_mo < median(median_income_12_mo, na.rm = TRUE) ~ "2_income", # Between Q1 and Q3
      median_income_12_mo >= median(median_income_12_mo, na.rm = TRUE) & median_income_12_mo <= Q3 ~ "3_income", # Between Q1 and Q3
      median_income_12_mo > Q3 ~ "4_income",               # Above the third quartile
      TRUE ~ "1_income"                   # NA values indicate low median individual income levels by bracket
    )
  )

table(df_mort$strata_income_cat)


#Age

hist(df_mort$median_age_total)

df_mort <- df_mort %>%
  mutate(
    # Calculate Q1, Q3, and IQR for 'value' (you can replace 'value' with any column)
    Q1 = quantile(median_age_total, 0.25, na.rm = TRUE),
    Q3 = quantile(median_age_total, 0.75, na.rm = TRUE),
    
    # Create categories based on IQR
    strata_age_cat = case_when(
      median_age_total < Q1 ~ "1_age",                # Below the first quartile
      median_age_total >= Q1 & median_age_total <= median(median_age_total) ~ "2_age", # Between Q1 and Q3
      median_age_total > median(median_age_total) & median_age_total <= Q3 ~ "3_age", # Between Q1 and Q3
      median_age_total > Q3 ~ "4_age",               # Above the third quartile
      TRUE ~ "Unknown"                   # In case there are NA values
    )
  )

table(df_mort$strata_age_cat)

#Sex

df_mort$strata_sex_cat <- ifelse(df_mort$P_county_male_pop > 50, "Maj_Male", "Maj_Female")

table(df_mort$strata_sex_cat)

#Race (without ethnicity)

df_mort$P_non_white_only_pop <- 100 - df_mort$P_county_white_pop

summary(df_mort$P_non_white_only_pop)

df_mort <- df_mort %>%
  mutate(
    white_non_ratio = P_county_white_pop / ifelse(P_non_white_only_pop < 1, 1, P_non_white_only_pop)
  )

df_mort <- df_mort %>%
  mutate(
    # Calculate Q1, Q3, and IQR for 'value' (you can replace 'value' with any column)
    Q1 = quantile(white_non_ratio, 0.25, na.rm = TRUE),
    Q3 = quantile(white_non_ratio, 0.75, na.rm = TRUE),
    
    # Create categories based on IQR
    strata_race_cat = case_when(
      white_non_ratio < Q1 ~ "1_race",                # Even or lower white-to-non-white ratio
      white_non_ratio >= Q1 & white_non_ratio <= Q3 ~ "2_race", # Between Q1 and Q3
      white_non_ratio > Q3 ~ "3_race",               # Above the third quartile (white white pop)
      TRUE ~ "Unknown"                   # In case there are NA values
    )
  )

table(df_mort$strata_race_cat)

#Composite strata

df_mort$strata <- as.factor(paste(df_mort$strata_sex_cat,
                        df_mort$strata_age_cat,
                        df_mort$strata_race_cat,
                        df_mort$strata_income_cat))


```

#Mortality

```{r}

df_mort$covid_deaths <- as.numeric(df_mort$Deaths) #NAs introduced

df_mort$Population <- as.numeric(df_mort$Population)

df_mort$Population <- ifelse(is.na(df_mort$Population), df_mort$total_pop, df_mort$Population)
summary(df_mort$Population)

#Imputing suppressed deaths
df_mort <- df_mort %>%
  mutate(deaths_imputed = ifelse(is.na(covid_deaths), sample(1:4, sum(is.na(covid_deaths)), replace = TRUE), covid_deaths))

summary(df_mort$deaths_imputed)

#Crude rate

df_mort$covid_mortality_rate_100k <- (df_mort$deaths_imputed / df_mort$Population) * 100000
summary(df_mort$covid_mortality_rate_100k) #Almost normally distributed
boxplot(df_mort$covid_mortality_rate_100k)

df_max <- filter(df_mort,covid_mortality_rate_100k > 900 )

#Outliers 99%

outliers <- as.data.frame(check_outliers(df_mort$covid_mortality_rate_100k))

df_mort_99 <- df_mort[!outliers$Outlier, ]

hist(df_mort_99$covid_mortality_rate_100k) # ostensibly normally distributed

#Save df_mort_99

save(df_mort_99, file = "/Users/fisherv1/Library/CloudStorage/OneDrive-MichiganStateUniversity/PROWESS/Research/03_Active Research/MAIHDA_Methods_MS/03_Code/MAIHDA_Methods/df_mort_99.rda")

```


```{r}

load("/Users/fisherv1/Library/CloudStorage/OneDrive-MichiganStateUniversity/PROWESS/Research/03_Active Research/MAIHDA_Methods_MS/03_Code/MAIHDA_Methods/df_mort_99.rda")
#Checking cell counts of strata is sufficient for analysis

strata_df <- df_mort_99 %>%
  group_by(strata) %>%
  mutate(strataN = n())

total_rows <- length(strata_df$strataN)
rows_with_20_or_more <- sum(strata_df$strataN >= 20) 
percentage <- (rows_with_20_or_more / total_rows) * 100

print(percentage) #92%

strata_sum <- df_mort_99 %>%
  group_by(strata) %>%
  summarise(across(where(is.numeric), ~ mean(., na.rm = TRUE)))

ggplot(strata_df, aes(reorder(strata, covid_mortality_rate_100k, FUN = median), covid_mortality_rate_100k))+
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```
#Model selection    

```{r}

lmer1 <- lmer(covid_mortality_rate_100k ~ 1 + (1 | strata), df_mort_99)
summary(lmer1)
check_model(lmer1)

glmm1 <- glmmTMB(covid_mortality_rate_100k ~ 1 + (1 | strata), df_mort_99, family = "gaussian")
summary(glmm1)
check_model(glmm1)

brms1 <- brm(covid_mortality_rate_100k ~ 1 + (1 | strata), df_mort_99, family = "gaussian")
summary(brms1)
check_model(brms1)
loo(brms1)


compare_performance(lmer1, glmm1, rank = TRUE) #glmm1 is preferred

```
#Going to try with GLMM

```{r}
colnames(df_mort_99)
#Unadjusted

glmm1 <- glmmTMB(covid_mortality_rate_100k ~ 1 + (1 | strata_sex_cat:strata_age_cat:strata_income_cat:strata_race_cat), df_mort_99, family = "gaussian")
summary(glmm1)
AIC(glmm1) #30833.53
icc(glmm1)$ICC_adjusted #0.33
check_model(glmm1)


#Adjusted with continuous strata

glmm2 <- glmmTMB(covid_mortality_rate_100k ~ standardise(median_age_total) + standardise(median_income_12_mo) + standardise(P_county_male_pop) + standardise(white_non_ratio) + (1 | strata_sex_cat:strata_age_cat:strata_income_cat:strata:strata_race_cat), df_mort_99, family = "gaussian")
summary(glmm2)
AIC(glmm2) #30586.19
icc(glmm2)$ICC_adjusted #0.33
check_model(glmm2)


#Adjusted with categorical strata

glmm3 <- glmmTMB(covid_mortality_rate_100k ~ strata_sex_cat + strata_age_cat + strata_income_cat + strata_race_cat + (1 | strata_sex_cat:strata_age_cat:strata_income_cat:strata_race_cat), df_mort_99, family = "gaussian")
summary(glmm3)
AIC(glmm3) #30670.15
icc(glmm3)$ICC_adjusted #0.33
check_model(glmm3)

```

#Bayesian

```{r}
brms1 <- brm(covid_mortality_rate_100k ~ 1 + (1 | strata), df_mort_99, family = "gaussian")
summary(brms1)
check_model(brms1)
loo(brms1) #looic 30676


brms2 <- brm(covid_mortality_rate_100k ~ standardise(median_age_total) + standardise(median_income_12_mo) + standardise(P_county_male_pop) + standardise(white_non_ratio) + (1 | strata_sex_cat:strata_age_cat:strata_income_cat:strata_race_cat), df_mort_99, family = "gaussian")
summary(brms2)
plot(brms2)


brms3 <- brm(covid_mortality_rate_100k ~ strata_sex_cat + strata_age_cat + strata_income_cat + strata_race_cat + (1 | strata_sex_cat:strata_age_cat:strata_income_cat:strata_race_cat), df_mort_99, family = "gaussian")
summary(brms2)



loo(brms1, brms3)

```

